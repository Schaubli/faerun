"use strict";function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},_createClass=function(){function t(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,i,n){return i&&t(e.prototype,i),n&&t(e,n),e}}(),ArrayHelper=function(){function t(){_classCallCheck(this,t)}return _createClass(t,null,[{key:"clone",value:function(e){var i=Array.isArray(e)?[]:{};for(var n in e){var r=e[n];"function"==typeof r.clone?i[n]=r.clone():i[n]="object"===("undefined"==typeof r?"undefined":_typeof(r))?t.clone(r):r}return i}},{key:"print",value:function(t){if(0==t.length)return"";for(var e="(",i=0;i<t.length;i++)e+=t[i].id?t[i].id+", ":t[i]+", ";return e=e.substring(0,e.length-2),e+")"}},{key:"each",value:function(t,e){for(var i=0;i<t.length;i++)e(t[i])}},{key:"get",value:function(t,e,i){for(var n=0;n<t.length;n++)if(t[n][e]==i)return t[n]}},{key:"contains",value:function(t,e){if(e.property||e.func){if(e.func){for(var i=0;i<t.length;i++)if(e.func(t[i]))return!0}else for(var n=0;n<t.length;n++)if(t[n][e.property]==e.value)return!0}else for(var r=0;r<t.length;r++)if(t[r]==e.value)return!0;return!1}},{key:"intersection",value:function t(e,i){for(var t=new Array,n=0;n<e.length;n++)for(var r=0;r<i.length;r++)e[n]===i[r]&&t.push(e[n]);return t}},{key:"unique",value:function(t){var e={};return t.filter(function(t){return void 0===e[t]&&(e[t]=!0)})}},{key:"count",value:function t(e,i){for(var t=0,n=0;n<e.length;n++)e[n]===i&&t++;return t}},{key:"toggle",value:function(t,e){for(var i=[],n=!1,r=0;r<t.length;r++)t[r]!==e?i.push(t[r]):n=!0;return n||i.push(e),i}},{key:"remove",value:function(t,e){for(var i=[],n=0;n<t.length;n++)t[n]!==e&&i.push(t[n]);return i}},{key:"removeAll",value:function(t,e){return t.filter(function(t){return e.indexOf(t)===-1})}},{key:"merge",value:function(t,e){for(var i=new Array(t.length+e.length),n=0;n<t.length;n++)i[n]=t[n];for(var r=0;r<e.length;r++)i[t.length+r]=e[r];return i}},{key:"containsAll",value:function(t,e){for(var i=0,n=0;n<t.length;n++)for(var r=0;r<e.length;r++)t[n]===e[r]&&i++;return i===e.length}}]),t}(),Atom=function(){function t(e){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"-";_classCallCheck(this,t),this.element=e,this.ringbonds=new Array,this.rings=new Array,this.bondType=i,this.isTerminal=!1,this.isBridge=!1,this.isBridgeNode=!1,this.bridgedRing=null,this.anchoredRings=new Array,this.bracket=null}return _createClass(t,[{key:"addAnchoredRing",value:function(t){ArrayHelper.contains(this.anchoredRings,{value:t})||this.anchoredRings.push(t)}},{key:"getRingbondCount",value:function(){return this.ringbonds.length}},{key:"canRotate",value:function(){return"-"===this.bondType&&0==this.rings.length}},{key:"hasRingbonds",value:function(){return this.ringbonds.length>0}},{key:"getMaxRingbond",value:function(){for(var t=0,e=0;e<this.ringbonds.length;e++)this.ringbonds[e].id>t&&(t=this.ringbonds[e].id);return t}},{key:"hasRing",value:function(t){for(var e=0;e<this.rings;e++)if(t===this.rings[e])return!0;return!1}},{key:"haveCommonRingbond",value:function(t,e){for(var i=0;i<t.ringbonds.length;i++)for(var n=0;n<e.ringbonds.length;n++)if(t.ringbonds[i].id==e.ringbonds[n].id)return!0;return!1}},{key:"maxCommonRingbond",value:function(t,e){for(var i=0,n=0,r=0,s=0;s<t.ringbonds.length;s++){t.ringbonds[s].id>n&&(n=t.ringbonds[s].id);for(var o=0;o<e.ringbonds.length;o++)e.ringbonds[o].id>r?r=e.ringbonds[o].id:n==r&&(i=n)}return i}}]),t}(),SmilesDrawer=function(){function t(e){_classCallCheck(this,t),this.width=800,this.height=500,this.ringIdCounter=0,this.ringConnectionIdCounter=0,this.canvas,this.ctx,this.drawingWidth=0,this.drawingHeight=0,this.offsetX=0,this.offsetY=0,this.maxBonds={c:4,C:4,n:3,N:3,o:2,O:2},this.defaultOptions={shortBondLength:20,bondLength:25,bondSpacing:4,defaultDir:-1,debug:!1,themes:{dark:{C:"#fff",O:"#e74c3c",N:"#3498db",F:"#27ae60",CL:"#16a085",BR:"#d35400",I:"#8e44ad",P:"#d35400",S:"#f1c40f",B:"#e67e22",SI:"#e67e22",BACKGROUND:"#141414"},light:{C:"#222",O:"#e74c3c",N:"#3498db",F:"#27ae60",CL:"#16a085",BR:"#d35400",I:"#8e44ad",P:"#d35400",S:"#f1c40f",B:"#e67e22",SI:"#e67e22",BACKGROUND:"#fff"}}},this.opts=this.extend(!0,this.defaultOptions,e),this.theme=this.opts.themes.dark}return _createClass(t,[{key:"extend",value:function(){var t=this,e={},i=!1,n=0,r=arguments.length;"[object Boolean]"===Object.prototype.toString.call(arguments[0])&&(i=arguments[0],n++);for(var s=function(n){for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(i&&"[object Object]"===Object.prototype.toString.call(n[r])?e[r]=t.extend(!0,e[r],n[r]):e[r]=n[r])};n<r;n++){var o=arguments[n];s(o)}return e}},{key:"draw",value:function(t,e){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"dark",n=arguments.length>3&&void 0!==arguments[3]&&arguments[3];if(this.data=t,this.canvas=document.getElementById(e),this.ctx=this.canvas.getContext("2d"),this.ringIdCounter=0,this.ringConnectionIdCounter=0,this.vertices=[],this.edges=[],this.rings=[],this.ringConnections=[],this.backupVertices=[],this.backupRings=[],this.colors=this.opts.themes[i],this.ctx.clearRect(0,0,this.canvas.offsetWidth,this.canvas.offsetHeight),this.initGraph(t),this.initRings(),!n){this.position();for(var r=this.getOverlapScore(),s=0;r.total>this.opts.bondLength/2&&s<10;){this.clearPositions(),this.position();var o=this.getOverlapScore();o.total<r.total?r=o:this.restorePositions(),s++}this.resolveSecondaryOverlaps(r.scores);for(var h={x:-Number.MAX_VALUE,y:-Number.MAX_VALUE},a={x:Number.MAX_VALUE,y:Number.MAX_VALUE},l=0;l<this.vertices.length;l++){var u=this.vertices[l].position;h.x<u.x&&(h.x=u.x),h.y<u.y&&(h.y=u.y),a.x>u.x&&(a.x=u.x),a.y>u.y&&(a.y=u.y)}var c=20;h.x+=c,h.y+=c,a.x-=c,a.y-=c,this.drawingWidth=h.x-a.x,this.drawingHeight=h.y-a.y;var g=this.canvas.offsetWidth/this.drawingWidth,v=this.canvas.offsetHeight/this.drawingHeight,d=g<v?g:v;this.ctx.scale(d,d),this.offsetX=-a.x,this.offsetY=-a.y,g<v?this.offsetY+=this.canvas.offsetHeight/(2*d)-this.drawingHeight/2:this.offsetX+=this.canvas.offsetWidth/(2*d)-this.drawingWidth/2,this.drawEdges(),this.drawVertices(this.opts.debug),this.ctx.setTransform(1,0,0,1,0,0)}}},{key:"edgeRingCount",value:function(t){var e=this.edges[t],i=this.vertices[e.sourceId],n=this.vertices[e.targetId];return Math.min(i.value.rings.length,n.value.rings.length)}},{key:"getBridgedRings",value:function(){for(var t=[],e=0;e<this.rings.length;e++)this.rings[e].isBridged&&t.push(this.rings[e]);return t}},{key:"getFusedRings",value:function(){for(var t=[],e=0;e<this.rings.length;e++)this.rings[e].isFused&&t.push(this.rings[e]);return t}},{key:"getSpiros",value:function(){for(var t=[],e=0;e<this.rings.length;e++)this.rings[e].isSpiro&&t.push(this.rings[e]);return t}},{key:"printRingInfo",value:function(){for(var t="",e=0;e<this.rings.length;e++){var i=this.rings[e];t+=i.id+";",t+=i.members.length+";",t+=i.neighbours.length+";",t+=i.isSpiro?"true;":"false;",t+=i.isFused?"true;":"false;",t+=i.isBridged?"true;":"false;",t+=i.rings.length+";",t+=i.insiders.length,t+="\n"}return t}},{key:"initGraph",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=new Atom(t.atom.element?t.atom.element:t.atom,t.bond);n.branchBond=t.branchBond,n.ringbonds=t.ringbonds,n.bracket=t.atom.element?t.atom:null;var r=new Vertex(n),s=this.vertices[e];if(r.parentVertexId=e,this.addVertex(r),null!=e){this.vertices[e].children.push(r.id),this.vertices[e].spanningTreeChildren.push(r.id);var o=new Edge(e,r.id,1);i?o.bondType=r.value.branchBond:o.bondType=this.vertices[e].value.bondType;var h=this.addEdge(o);r.edges.push(h),s.edges.push(h)}for(var a=0;a<t.branchCount;a++)this.initGraph(t.branches[a],r.id,!0);t.hasNext&&this.initGraph(t.next,r.id)}},{key:"getRingbondType",value:function(t,e){if(t.value.getRingbondCount()<1||e.value.getRingbondCount()<1)return null;for(var i=0;i<t.value.ringbonds.length;i++)for(var n=0;n<e.value.ringbonds.length;n++)if(t.value.ringbonds[i].id==e.value.ringbonds[n].id)return"-"==t.value.ringbonds[i].bondType?e.value.ringbonds[n].bond:t.value.ringbonds[i].bond;return null}},{key:"initRings",value:function(){for(var t=this,e={},i=this.vertices.length-1;i>=0;i--){var n=this.vertices[i];if(0!==n.value.ringbonds.length)for(var r=0;r<n.value.ringbonds.length;r++){var s=n.value.ringbonds[r].id;if(void 0===e[s])e[s]=n.id;else{var o=e[s],h=n.id,a=t.addEdge(new Edge(h,o,1));t.vertices[h].children.push(o),t.vertices[o].children.push(h),t.vertices[h].edges.push(a),t.vertices[o].edges.push(a);var l=new Ring(s,h,o);t.addRing(l);for(var u=t.annotateRing(l.id,l.sourceId,l.targetId),c=0;c<u.length;c++)l.members.push(u[c]),t.vertices[u[c]].value.rings.push(l.id);e[s]=void 0}}}for(var g=0;g<this.rings.length-1;g++)for(var v=g+1;v<this.rings.length;v++){var d=this.rings[g],f=this.rings[v],p=new RingConnection(d,f);p.vertices.length>0&&this.addRingConnection(p)}for(var y=0;y<this.rings.length;y++){var m=this.rings[y];m.neighbours=RingConnection.getNeighbours(this.ringConnections,m.id)}for(;this.rings.length>0;){for(var b=-1,x=0;x<this.rings.length;x++){var A=this.rings[x];this.isPartOfBridgedRing(A.id)&&(b=A.id)}if(b===-1)break;var k=this.getRing(b),C=this.getBridgedRingRings(k.id);this.createBridgedRing(C,k.sourceId);for(var R=0;R<C.length;R++)this.removeRing(C[R])}}},{key:"getBridgedRingRings",value:function(t){var e=new Array,i=this,n=function t(n){var r=i.getRing(n);e.push(n);for(var s=0;s<r.neighbours.length;s++){var o=r.neighbours[s];e.indexOf(o)===-1&&o!==n&&RingConnection.isBridge(i.ringConnections,i.vertices,n,o)&&t(o)}};return n(t),ArrayHelper.unique(e)}},{key:"isPartOfBridgedRing",value:function(t){for(var e=0;e<this.ringConnections.length;e++)if(this.ringConnections[e].rings.contains(t)&&this.ringConnections[e].isBridge(this.vertices))return!0;return!1}},{key:"createBridgedRing",value:function(t,e){for(var i=new Array,n=new Array,r=new Array,s=(new Array,0);s<t.length;s++){for(var o=this.getRing(t[s]),h=0;h<o.members.length;h++)n.push(o.members[h]);for(var a=0;a<o.neighbours.length;a++)r.push(o.neighbours[a])}n=ArrayHelper.unique(n);for(var l=new Array,u=0;u<n.length;u++){var c=this.vertices[n[u]],g=ArrayHelper.intersection(t,c.value.rings);1==c.value.rings.length||1==g.length?i.push(c.id):l.push(c.id)}for(var v=new Array,d=new Array,f=0;f<l.length;f++){for(var p=this.vertices[l[f]],y=!1,m=0;m<p.edges.length;m++)1==this.edgeRingCount(p.edges[m])&&(y=!0);y?(p.value.isBridgeNode=!0,v.push(p.id)):(p.value.isBridge=!0,d.push(p.id))}var b=ArrayHelper.merge(i,v);r=ArrayHelper.unique(r),r=ArrayHelper.removeAll(r,t);for(var x=this.vertices[e],A=x.getNeighbours(),k=null,C=0;C<A.length;C++){var R=A[C];b.indexOf(R)!==-1&&(k=R)}var w=new Ring(-1,e,k);w.isBridged=!0,w.members=b,w.neighbours=r,w.insiders=d;for(var V=0;V<t.length;V++)w.rings.push(this.getRing(t[V]).clone());this.addRing(w);for(var N=0;N<d.length;N++){var S=this.vertices[d[N]];S.value.rings=new Array,S.value.bridgedRing=w.id}for(var B=0;B<b.length;B++){var I=this.vertices[b[B]];I.value.rings=ArrayHelper.removeAll(I.value.rings,t),I.value.rings.push(w.id)}for(var T=0;T<t.length;T++)for(var H=T+1;H<t.length;H++)this.removeRingConnectionBetween(t[T],t[H]);for(var M=0;M<r.length;M++)for(var L=this.getRingConnections(r[M],t),P=0;P<L.length;P++)this.getRingConnection(L[P]).updateOther(w.id,r[M]);return w}},{key:"ringCounter",value:function(t,e){for(var i=0;i<t.getRingbondCount();i++){var n=t.ringbonds[i].id;this.arrayContains(e,{value:n})||e.push(n)}for(var i=0;i<t.branchCount;i++)this.ringCounter(t.branches[i],e);return t.hasNext&&this.ringCounter(t.next,e),e}},{key:"annotateRing",value:function(t,e,i){for(var n=this.dijkstra(e,i),r=[],s=[],o=i;null!=o;)r.push(o),o=n[o];for(var h=r.length-1;h>=0;h--)s.push(r[h]);return s}},{key:"dijkstra",value:function(t,e){for(var i=new Array(this.vertices.length),n=new Array(this.vertices.length),r=new Array(this.vertices.length),s=new Array(this.vertices.length),o=0;o<this.vertices.length;o++)n[o]=o==t?0:Number.MAX_VALUE,i[o]=null,r[o]=!1,s[o]=this.vertices[o].getNeighbours();for(;ArrayHelper.count(r,!1)>0;){var h=this.getMinDist(n,r);if(h==e)return i;r[h]=!0;for(var o=0;o<s[h].length;o++){var a=s[h][o],l=n[h]+this.getEdgeWeight(h,a);h==t&&a==e||h==e&&a==t||l<n[a]&&(n[a]=l,i[a]=h)}}}},{key:"areVerticesInSameRing",value:function(t,e){for(var i=0;i<t.value.rings.length;i++)for(var n=0;n<e.value.rings.length;n++)if(t.value.rings[i]==e.value.rings[n])return!0;return!1}},{key:"getCommonRings",value:function(t,e){for(var i=[],n=0;n<t.value.rings.length;n++)for(var r=0;r<e.value.rings.length;r++)t.value.rings[n]==e.value.rings[r]&&i.push(t.value.rings[n]);return i}},{key:"getSmallestCommonRing",value:function(t,e){for(var i=this.getCommonRings(t,e),n=Number.MAX_VALUE,r=null,s=0;s<i.length;s++){var o=this.getRing(i[s]).getSize();o<n&&(n=o,r=this.getRing(i[s]))}return r}},{key:"getLargestCommonRing",value:function(t,e){for(var i=this.getCommonRings(t,e),n=0,r=null,s=0;s<i.length;s++){var o=this.getRing(i[s]).getSize();o>n&&(n=o,r=this.getRing(i[s]))}return r}},{key:"getMinDist",value:function(t,e){for(var i=Number.MAX_VALUE,n=null,r=0;r<t.length;r++)e[r]||t[r]<i&&(n=r,i=t[n]);return n}},{key:"getEdgeWeight",value:function(t,e){for(var i=0;i<this.edges.length;i++){var n=this.edges[i];if(n.sourceId==t&&n.targetId==e||n.targetId==t&&n.sourceId==e)return n.weight}}},{key:"addVertex",value:function(t){return t.id=this.vertices.length,this.vertices.push(t),t.id}},{key:"getVerticesAt",value:function(t,e,i){for(var n=new Array,r=0;r<this.vertices.length;r++){var s=this.vertices[r];if(s.id!==i&&s.positioned){var o=t.distance(s.position);o<=e&&n.push(s.id)}}return n}},{key:"getBranch",value:function(t,e){var i=new Array,n=new Array,r=this,s=function t(e,s){for(var o=r.vertices[e],h=0;h<o.value.rings.length;h++)n.push(o.value.rings[h]);for(var h=0;h<o.children.length;h++){var a=o.children[h];a===s||ArrayHelper.contains(i,{value:a})||(i.push(a),t(a,e))}var l=o.parentVertexId;l===s||null===l||ArrayHelper.contains(i,{value:l})||(i.push(l),t(l,e))};return i.push(t),s(t,e),{vertices:i,rings:ArrayHelper.unique(n)}}},{key:"addEdge",value:function(t){return t.id=this.edges.length,this.edges.push(t),t.id}},{key:"addRing",value:function(t){return t.id=this.ringIdCounter++,this.rings.push(t),t.id}},{key:"removeRing",value:function(t){this.rings=this.rings.filter(function(e){return e.id!==t}),this.ringConnections=this.ringConnections.filter(function(e){return e.rings.first!==t&&e.rings.second!==t});for(var e=0;e<this.rings.length;e++){var i=this.rings[e];i.neighbours=i.neighbours.filter(function(e){return e!==t})}}},{key:"getRing",value:function(t){for(var e=0;e<this.rings.length;e++)if(this.rings[e].id==t)return this.rings[e]}},{key:"addRingConnection",value:function(t){return t.id=this.ringConnectionIdCounter++,this.ringConnections.push(t),t.id}},{key:"removeRingConnection",value:function(t){this.ringConnections=this.ringConnections.filter(function(e){return e.id!==t})}},{key:"removeRingConnectionBetween",value:function(t,e){for(var i=new Array,n=0;n<this.ringConnections.length;n++){var r=this.ringConnections[n];(r.rings.first===t&&r.rings.second===e||r.rings.first===e&&r.rings.second===t)&&i.push(r.id)}for(var n=0;n<i.length;n++)this.removeRingConnection(i[n])}},{key:"getRingConnection",value:function(t){for(var e=0;e<this.ringConnections.length;e++)if(this.ringConnections[e].id==t)return this.ringConnections[e]}},{key:"getRingConnections",value:function(t,e){var i=new Array;if(1===arguments.length)for(var n=0;n<this.ringConnections.length;n++){var r=this.ringConnections[n];r.rings.first!==t&&r.rings.second!==t||i.push(r.id)}else if(e.constructor!==Array)for(var n=0;n<this.ringConnections.length;n++){var r=this.ringConnections[n];(r.rings.first===t&&r.rings.second===e||r.rings.first===e&&r.rings.second===t)&&i.push(r.id)}else for(var n=0;n<this.ringConnections.length;n++)for(var s=0;s<e.length;s++){var o=e[s],r=this.ringConnections[n];(r.rings.first===t&&r.rings.second===o||r.rings.first===o&&r.rings.second===t)&&i.push(r.id)}return i}},{key:"getOverlapScore",value:function(){for(var t=0,e=new Float32Array(this.vertices.length),i=0;i<this.vertices.length;i++)e[i]=0;for(var i=0;i<this.vertices.length;i++)for(var n=i+1;n<this.vertices.length;n++){var r=this.vertices[i],s=this.vertices[n],o=Vector2.subtract(r.position,s.position).length();if(o<this.opts.bondLength){var h=this.opts.bondLength-o;t+=h,e[i]+=h,e[n]+=h}}for(var a=[],i=0;i<this.vertices.length;i++)a.push({id:i,score:e[i]});return a.sort(function(t,e){return e.score-t.score}),{total:t,scores:a}}},{key:"getColor",value:function(t){return t in this.colors?this.colors[t]:this.colors.C}},{key:"circle",value:function(t,e,i,n,r,s){isNaN(e)||isNaN(i)||(this.ctx.save(),this.ctx.lineWidth=1.5,this.ctx.beginPath(),this.ctx.arc(e+this.offsetX,i+this.offsetY,t,0,2*Math.PI,!0),this.ctx.closePath(),s?r?(this.ctx.fillStyle="#ff0000",this.ctx.fill()):(this.ctx.strokeStyle="#ff0000",this.ctx.stroke()):r?(this.ctx.fillStyle=this.colors.C,this.ctx.fill()):(this.ctx.strokeStyle=this.colors.C,this.ctx.stroke()),this.ctx.restore())}},{key:"line",value:function t(e,i,n,r,s,o,h){if(!(isNaN(e)||isNaN(i)||isNaN(n)||isNaN(r))){var t=new Line(new Vector2(e,i),new Vector2(n,r),s,o),a=t.clone().shorten(8),l=a.getLeftVector().clone(),u=a.getRightVector().clone();l.x+=this.offsetX,l.y+=this.offsetY,u.x+=this.offsetX,u.y+=this.offsetY,this.ctx.save(),this.ctx.beginPath(),this.ctx.moveTo(l.x,l.y),this.ctx.lineTo(u.x,u.y),this.ctx.lineCap="round",this.ctx.lineWidth=3.5,this.ctx.shadowColor=this.colors.BACKGROUND,this.ctx.shadowBlur=0,this.ctx.shadowOffsetX=0,this.ctx.shadowOffsetY=0,this.ctx.strokeStyle=this.colors.BACKGROUND,this.ctx.stroke(),this.ctx.restore();var l=t.getLeftVector().clone(),u=t.getRightVector().clone();l.x+=this.offsetX,l.y+=this.offsetY,u.x+=this.offsetX,u.y+=this.offsetY,this.ctx.save(),this.ctx.beginPath(),this.ctx.moveTo(l.x,l.y),this.ctx.lineTo(u.x,u.y),this.ctx.lineCap="round",this.ctx.lineWidth=1.5;var c=this.ctx.createLinearGradient(l.x,l.y,u.x,u.y);c.addColorStop(.4,this.colors[t.getLeftElement().toUpperCase()]||this.colors.C),c.addColorStop(.6,this.colors[t.getRightElement().toUpperCase()]||this.colors.C),this.ctx.strokeStyle=c,this.ctx.stroke(),this.ctx.restore()}}},{key:"debugText",value:function(t,e,i){this.ctx.save();var n="5px Arial";this.ctx.font=n,this.ctx.textAlign="start",this.ctx.textBaseline="top",this.ctx.fillStyle="#ff0000",this.ctx.fillText(i,t+this.offsetX,e+this.offsetY),this.ctx.restore()}},{key:"text",value:function(t,e,i,n,r,s,o,h,a){if(!isNaN(t)&&!isNaN(e)){this.ctx.save();var l="10px Arial",u="6px Arial";this.ctx.textAlign="start",this.ctx.textBaseline="top";var c=0;if(a){var g="+";2===a?g="2+":a===-1?g="-":a===-2&&(g="2-"),this.ctx.font=u,c=this.ctx.measureText(g).width}this.ctx.font=l,this.ctx.fillStyle=this.colors.BACKGROUND;var v=this.ctx.measureText(i);v.totalWidth=v.width+c,v.height=parseInt(l,10);var d=v.totalWidth>v.height?v.totalWidth:v.height;d/=2,this.ctx.globalCompositeOperation="destination-out",this.ctx.beginPath(),this.ctx.arc(t+this.offsetX,e+this.offsetY+v.height/20,d+1,0,2*Math.PI,!0),this.ctx.closePath(),this.ctx.fill(),this.ctx.globalCompositeOperation="source-over",e-=2,this.ctx.fillStyle=this.getColor(i.toUpperCase()),this.ctx.fillText(i,t-v.totalWidth/2+this.offsetX,e-v.height/2+this.offsetY),a&&(this.ctx.font=u,this.ctx.fillText(g,t-v.totalWidth/2+v.width+this.offsetX,e-v.height/2+this.offsetY)),this.ctx.font=l;var f=this.ctx.measureText("H");if(f.height=parseInt(l,10),1===s){var p=t-v.totalWidth/2+this.offsetX,y=e-v.height/2+this.offsetY;"left"===o?p-=v.totalWidth:"right"===o?p+=v.totalWidth:"up"===o&&h?p+=v.totalWidth:"down"===o&&h?p+=v.totalWidth:"up"!==o||h?"down"!==o||h||(y+=v.height):y-=v.height,this.ctx.fillText("H",p,y)}else if(s>1){var p=t-v.totalWidth/2+this.offsetX,y=e-v.height/2+this.offsetY;this.ctx.font=u;var m=this.ctx.measureText(s);m.height=parseInt(u,10),"left"===o?p-=f.width+m.width:"right"===o?p+=v.totalWidth:"up"===o&&h?p+=v.totalWidth:"down"===o&&h?p+=v.totalWidth:"up"!==o||h?"down"!==o||h||(y+=v.height):y-=v.height,this.ctx.font=l,this.ctx.fillText("H",p,y),this.ctx.font=u,this.ctx.fillText(s,p+f.width,y+f.height/2)}this.ctx.restore()}}},{key:"drawPoint",value:function(t,e){this.circle(2,t.x,t.y,"helper",!0,!0),e&&this.debugText(t.x,t.y,e,"id",!0)}},{key:"chooseSide",value:function(t,e,i){for(var n=t.getNeighbours(e.id),r=e.getNeighbours(t.id),s=n.length,o=r.length,h=ArrayHelper.merge(n,r),a=[0,0],l=0;l<h.length;l++){var u=this.vertices[h[l]].position;u.sameSideAs(t.position,e.position,i[0])?a[0]++:a[1]++}for(var c=[0,0],l=0;l<this.vertices.length;l++){var u=this.vertices[l].position;u.sameSideAs(t.position,e.position,i[0])?c[0]++:c[1]++}return{totalSideCount:c,totalPosition:c[0]>c[1]?0:1,sideCount:a,position:a[0]>a[1]?0:1,anCount:s,bnCount:o}}},{key:"connected",value:function(t,e){for(var i=0;i<this.edges.length;i++){var n=this.edges[i];if(n.sourceId===t&&n.targetId===e||n.sourceId===e&&n.targetId===t)return!0}return!1}},{key:"forceLayout",value:function(t,e,i,n){var r=this.opts.bondLength,s=6e3,o=5,h=.5;n.rings.length>2&&(s=1e3,o=1.5,h=0);for(var a=[],l=0;l<t.length;l++){var u=this.vertices[t[l]];if(u.value.isBridge)for(var c=u.getNeighbours(),g=0;g<c.length;g++){var v=c[g];ArrayHelper.contains(t,{value:v})||a.push(v)}}t=ArrayHelper.merge(t,a);for(var d=0;d<t.length;d++){var f=this.vertices[t[d]];f.positioned||(f.position.x=e.x+Math.random(),f.position.y=e.y+Math.random())}for(var p={},y=0;y<t.length;y++)p[t[y]]=new Vector2;for(var m=0;m<1e3;m++){for(var b=0;b<t.length;b++)p[t[b]].set(0,0);for(var x=0;x<t.length-1;x++)for(var A=this.vertices[t[x]],k=x+1;k<t.length;k++){var C=this.vertices[t[k]],R=C.position.x-A.position.x,w=C.position.y-A.position.y;if(0!==R&&0!==w){var V=R*R+w*w,N=Math.sqrt(V),S=s/V,B=S*R/N,I=S*w/N;A.positioned||(p[A.id].x-=B,p[A.id].y-=I),C.positioned||(p[C.id].x+=B,p[C.id].y+=I)}}if(n.rings.length>2)for(var T=new Array(n.rings.length),H=0;H<n.rings.length;H++){T[H]=new Vector2;for(var M=0;M<n.rings[H].members.length;M++)T[H].x+=this.vertices[n.rings[H].members[M]].position.x,T[H].y+=this.vertices[n.rings[H].members[M]].position.y;T[H].x/=n.rings[H].members.length,T[H].y/=n.rings[H].members.length,n.rings[H].center.set(T[H].x,T[H].y);for(var L=0;L<n.rings[H].members.length;L++){var P=this.vertices[n.rings[H].members[L]],O=T[H].x-P.position.x,F=T[H].y-P.position.y;if(0!==O&&0!==F){var E=O*O+F*F,_=Math.sqrt(E),z=s/E;5!==n.rings[H].members.length&&6!==n.rings[H].members.length||(z*=10);var D=z*O/_,W=z*F/_;P.positioned||(p[P.id].x-=D,p[P.id].y-=W)}}}for(var X=0;X<t.length-1;X++)for(var j=this.vertices[t[X]],U=X+1;U<t.length;U++){var q=this.vertices[t[U]];if(j.isNeighbour(q.id)){var Y=q.position.x-j.position.x,G=q.position.y-j.position.y;if(0!==Y&&0!==G){var K=Math.sqrt(Y*Y+G*G),$=o*(K-r);$*=K<r?.5:2;var Z=$*Y/K,J=$*G/K;j.positioned||(p[j.id].x+=Z,p[j.id].y+=J),q.positioned||(p[q.id].x-=Z,p[q.id].y-=J)}}}for(var Q=0;Q<t.length;Q++){var tt=this.vertices[t[Q]],et=e.x-tt.position.x,it=e.y-tt.position.y;if(0!==et&&0!==it){var nt=Math.sqrt(et*et+it*it),rt=h*(1/nt),st=rt*et/nt,ot=rt*it/nt;tt.positioned||(p[tt.id].x+=st,p[tt.id].y+=ot)}}for(var ht=0;ht<t.length;ht++){var at=this.vertices[t[ht]];if(!at.positioned){var lt=.1*p[at.id].x,ut=.1*p[at.id].y,ct=lt*lt+ut*ut;if(ct>500){var gt=Math.sqrt(500/ct);lt*=gt,ut*=gt}at.position.x+=lt,at.position.y+=ut}}}for(var vt=0;vt<t.length;vt++)this.vertices[t[vt]].positioned=!0;for(var dt=0;dt<t.length;dt++)for(var ft=this.vertices[t[dt]],pt=this.vertices[ft.parentVertexId],yt=ft.getNeighbours(),mt=ft.getAngle(null,!0)-60,bt=0;bt<yt.length;bt++)ft.value.isBridge||void 0!==pt&&pt.value.isBridge?(console.log("angle",yt[bt]),this.createBonds(this.vertices[yt[bt]],ft,MathHelper.toRad(mt))):0===this.vertices[yt[bt]].value.rings.length&&(n.rings.length>2&&(e=this.getSubringCenter(n,ft)),this.createBonds(this.vertices[yt[bt]],ft,e)),mt+=120}},{key:"getSubringCenter",value:function(t,e){for(var i=0;i<t.rings.length;i++)for(var n=t.rings[i],r=0;r<n.members.length;r++)if(n.members[r]===e.id)return console.log("returning subring center",n.center),n.center;return t.center}},{key:"drawEdges",value:function(t){for(var e=this,i=0;i<this.edges.length;i++){var n=this.edges[i],r=this.vertices[n.sourceId],s=this.vertices[n.targetId],o=r.value.element,h=s.value.element,a=r.position,l=s.position,u=this.getEdgeNormals(n),c=("gradient"+r.value.element.toUpperCase()+s.value.element.toUpperCase(),ArrayHelper.clone(u));if(ArrayHelper.each(c,function(t){t.multiply(10),t.add(a)}),"="===n.bondType||"="===this.getRingbondType(r,s)){var g=this.areVerticesInSameRing(r,s),v=this.chooseSide(r,s,c);if(g){var d=this.getLargestCommonRing(r,s),f=d.center;ArrayHelper.each(u,function(t){t.multiply(e.opts.bondSpacing)});var p=null;console.log("center",f),p=f.sameSideAs(r.position,s.position,Vector2.add(a,u[0]))?new Line(Vector2.add(a,u[0]),Vector2.add(l,u[0])):new Line(Vector2.add(a,u[1]),Vector2.add(l,u[1])),p.shorten(this.opts.bondLength-this.opts.shortBondLength),this.line(p.from.x,p.from.y,p.to.x,p.to.y,o,h),this.line(a.x,a.y,l.x,l.y,o,h)}else if(0==v.anCount&&v.bnCount>1||0==v.bnCount&&v.anCount>1){ArrayHelper.each(u,function(t){t.multiply(e.opts.bondSpacing/2)});var y=new Line(Vector2.add(a,u[0]),Vector2.add(l,u[0])),m=new Line(Vector2.add(a,u[1]),Vector2.add(l,u[1]));this.line(y.from.x,y.from.y,y.to.x,y.to.y,o,h),this.line(m.from.x,m.from.y,m.to.x,m.to.y,o,h)}else if(v.sideCount[0]>v.sideCount[1]){ArrayHelper.each(u,function(t){t.multiply(e.opts.bondSpacing)});var p=new Line(Vector2.add(a,u[0]),Vector2.add(l,u[0]));p.shorten(this.opts.bondLength-this.opts.shortBondLength),this.line(p.from.x,p.from.y,p.to.x,p.to.y,o,h),this.line(a.x,a.y,l.x,l.y,o,h)}else if(v.sideCount[0]<v.sideCount[1]){ArrayHelper.each(u,function(t){t.multiply(e.opts.bondSpacing)});var p=new Line(Vector2.add(a,u[1]),Vector2.add(l,u[1]));p.shorten(this.opts.bondLength-this.opts.shortBondLength),this.line(p.from.x,p.from.y,p.to.x,p.to.y,o,h),this.line(a.x,a.y,l.x,l.y,o,h)}else if(v.totalSideCount[0]>v.totalSideCount[1]){ArrayHelper.each(u,function(t){t.multiply(e.opts.bondSpacing)});var p=new Line(Vector2.add(a,u[0]),Vector2.add(l,u[0]));p.shorten(this.opts.bondLength-this.opts.shortBondLength),this.line(p.from.x,p.from.y,p.to.x,p.to.y,o,h),this.line(a.x,a.y,l.x,l.y,o,h)}else if(v.totalSideCount[0]<=v.totalSideCount[1]){ArrayHelper.each(u,function(t){t.multiply(e.opts.bondSpacing)});var p=new Line(Vector2.add(a,u[1]),Vector2.add(l,u[1]));p.shorten(this.opts.bondLength-this.opts.shortBondLength),this.line(p.from.x,p.from.y,p.to.x,p.to.y,o,h),this.line(a.x,a.y,l.x,l.y,o,h)}}else if("#"===n.bondType){ArrayHelper.each(u,function(t){t.multiply(e.opts.bondSpacing/1.5)});var b=new Line(Vector2.add(a,u[0]),Vector2.add(l,u[0])),x=new Line(Vector2.add(a,u[1]),Vector2.add(l,u[1]));b.shorten(this.opts.bondLength-this.opts.shortBondLength),x.shorten(this.opts.bondLength-this.opts.shortBondLength),this.line(b.from.x,b.from.y,b.to.x,b.to.y,o,h),this.line(x.from.x,x.from.y,x.to.x,x.to.y,o,h),this.line(a.x,a.y,l.x,l.y,o,h)}else this.line(a.x,a.y,l.x,l.y,o,h);if(t){var A=Vector2.midpoint(a,l);this.debugText(A.x,A.y,"id: "+i)}}}},{key:"drawVertices",value:function(t){for(var e=0;e<this.vertices.length;e++){var i=this.vertices[e],n=i.value,r=this.getBondCount(i),s=1==n.element.length?n.element.toUpperCase():n.element;if(t){var o=i.id+" "+ArrayHelper.print(n.ringbonds);this.debugText(i.position.x,i.position.y,"id: "+o)}var h=this.maxBonds[s]-r;n.bracket&&(h=n.bracket.hcount);var a=0;if(n.bracket&&(a=n.bracket.charge),i.isTerminal()){var l=i.getTextDirection(this.vertices);this.text(i.position.x,i.position.y,s,"element "+n.element.toLowerCase(),!0,h,l,!0,a)}else if("c"!==n.element.toLowerCase()){var l=i.getTextDirection(this.vertices);this.text(i.position.x,i.position.y,s,"element "+n.element.toLowerCase(),!0,h,l,!1,a)}}if(this.opts.debug)for(var e=0;e<this.rings.length;e++)this.drawPoint(this.rings[e].center,"id: "+this.rings[e].id);for(var e=0;e<this.rings.length;e++){var u=this.rings[e];u.isAromatic(this.vertices)&&(this.ctx.save(),this.ctx.strokeStyle=this.colors.C,this.ctx.lineWidth=1.5,this.ctx.beginPath(),this.ctx.arc(u.center.x+this.offsetX,u.center.y+this.offsetY,u.radius-10,0,2*Math.PI,!0),this.ctx.closePath(),this.ctx.stroke(),this.ctx.restore())}}},{key:"position",value:function(){for(var t=0,e=0;e<this.rings.length;e++)this.rings[e].isBridged&&(t=this.rings[e].members[e]);this.createBonds(this.vertices[t]),this.resolvePrimaryOverlaps()}},{key:"clearPositions",value:function(){this.backupVertices=[],this.backupRings=[];for(var t=0;t<this.vertices.length;t++){var e=this.vertices[t];this.backupVertices.push(e.clone()),e.positioned=!1,e.position=new Vector2}for(var t=0;t<this.rings.length;t++){var i=this.rings[t];this.backupRings.push(i.clone()),i.positioned=!1,i.center=new Vector2}}},{key:"restorePositions",value:function(){for(var t=0;t<this.backupVertices.length;t++)this.vertices[t]=this.backupVertices[t];for(var t=0;t<this.backupRings.length;t++)this.rings[t]=this.backupRings[t]}},{key:"createRing",value:function(t,e,i,n){var r=this;if(!t.positioned){var s=t.getOrderedNeighbours(this.ringConnections);e=e?e:new Vector2(0,0);var o=i?Vector2.subtract(i.position,e).angle():0,h=MathHelper.polyCircumradius(r.opts.bondLength,t.getSize());t.radius=h;var a=MathHelper.centralAngle(t.getSize());t.centralAngle=a;var l=o;if(t.eachMember(this.vertices,function(i){var n=r.vertices[i];n.positioned||(n.position.x=e.x+Math.cos(l)*h,n.position.y=e.y+Math.sin(l)*h),l+=a,(!t.isBridged||t.rings.length<3)&&(n.positioned=!0)},i?i.id:null,n?n.id:null),t.isBridged){var u=ArrayHelper.merge(t.members,t.insiders);this.forceLayout(u,e,i.id,t)}this.vertices[t.members[0]].value.addAnchoredRing(t.id),t.positioned=!0,t.center=e;for(var c=0;c<s.length;c++){var g=this.getRing(s[c].neighbour);if(!g.positioned){var v=RingConnection.getVertices(this.ringConnections,t.id,g.id);if(2==v.length){t.isFused=!0,g.isFused=!0;var d=this.vertices[v[0]],f=this.vertices[v[1]],p=Vector2.midpoint(d.position,f.position),y=Vector2.normals(d.position,f.position);ArrayHelper.each(y,function(t){t.normalize()});var m=MathHelper.polyCircumradius(r.opts.bondLength,g.getSize()),b=MathHelper.apothem(m,g.getSize());ArrayHelper.each(y,function(t){t.multiply(b)}),ArrayHelper.each(y,function(t){t.add(p)});var x=y[0];this.isPointInRing(x)&&(x=y[1]);var A=Vector2.subtract(d.position,x),k=Vector2.subtract(f.position,x);A.clockwise(k)===-1?this.createRing(g,x,d,f):this.createRing(g,x,f,d)}else if(1==v.length){t.isSpiro=!0,g.isSpiro=!0;var d=this.vertices[v[0]],x=Vector2.subtract(e,d.position);x.invert(),x.normalize();var m=MathHelper.polyCircumradius(r.opts.bondLength,g.getSize());x.multiply(m),x.add(d.position),this.createRing(g,x,d)}}}for(var c=0;c<t.members.length;c++)for(var C=this.vertices[t.members[c]],R=C.getNeighbours(),w=0;w<R.length;w++)if(!t.thisOrNeighboursContain(this.rings,R[w])){var V=this.vertices[R[w]];this.createBonds(V,C,t.center)}}}},{key:"rotateSubtree",value:function(t,e,i,n){var r=this;this.traverseTree(e,t,function(t){t.position.rotateAround(i,n);for(var e=0;e<t.value.anchoredRings.length;e++)r.rings[t.value.anchoredRings[e]].center.rotateAround(i,n)})}},{key:"resolvePrimaryOverlaps",value:function(){for(var t=[],e=[],i=new Array(this.vertices.length),n=0;n<this.rings.length;n++)for(var r=this.rings[n],s=0;s<r.members.length;s++){var o=this.vertices[r.members[s]];if(!i[o.id]){if(i[o.id]=!0,o.getNeighbours().length>2){for(var h=[],a=0;a<o.value.rings.length;a++)h.push(o.value.rings[a]);
t.push({common:o,rings:h,vertices:this.getNonRingNeighbours(o.id)})}if(2==o.value.rings.length&&4==o.getNeighbours().length){var l=this.getNonRingNeighbours(o.id)[0];if(l&&l.getNeighbours().length>1){var u=this.getCommonRingbondNeighbour(o);e.push({common:o,other:u,vertex:l})}}}}for(var n=0;n<e.length;n++){var c=e[n],g=-c.vertex.position.getRotateToAngle(c.other.position,c.common.position);this.rotateSubtree(c.vertex.id,c.common.id,g+Math.PI,c.common.position)}for(var n=0;n<t.length;n++){var v=t[n];if(1==v.vertices.length){var d=v.vertices[0];if(1==d.getNeighbours().length){d.flippable=!0,d.flipCenter=v.common.id;for(var s=0;s<v.rings.length;s++)d.flipRings.push(v.rings[s])}}else if(2==v.vertices.length){var g=(2*Math.PI-this.getRing(v.rings[0]).getAngle())/6,d=v.vertices[0],f=v.vertices[1];if(d.backAngle-=g,f.backAngle+=g,this.rotateSubtree(d.id,v.common.id,g,v.common.position),this.rotateSubtree(f.id,v.common.id,-g,v.common.position),1==d.getNeighbours().length){d.flippable=!0,d.flipCenter=v.common.id,d.flipNeighbour=f.id;for(var s=0;s<v.rings.length;s++)d.flipRings.push(v.rings[s])}if(1==f.getNeighbours().length){f.flippable=!0,f.flipCenter=v.common.id,f.flipNeighbour=d.id;for(var s=0;s<v.rings.length;s++)f.flipRings.push(v.rings[s])}}}}},{key:"resolveSecondaryOverlaps",value:function(t){for(var e=0;e<t.length;e++)if(t[e].score>this.opts.bondLength/5){var i=this.vertices[t[e].id];if(i.flippable){var n=i.flipRings[0]?this.rings[i.flipRings[0]]:null,r=i.flipRings[1]?this.rings[i.flipRings[1]]:null,s=this.vertices[i.flipCenter].position;if(n&&r){var o=n.members.length>r.members.length?n:r;r=n.members.length<r.members.length?n:r,n=o}n&&n.allowsFlip()?(i.position.rotateTo(n.center,s),n.setFlipped(),null!==i.flipNeighbour):r&&r.allowsFlip()&&(i.position.rotateTo(r.center,s),r.setFlipped(),null!==i.flipNeighbour)}}}},{key:"createBonds",value:function(t,e,i,n){if(!t.positioned){if(e)if(0!=e.value.rings.length||t.value.isBridge){if(e.value.isBridgeNode&&t.value.isBridge){var r=(this.getTargets(t.id,e.id,t.value.bridgedRing),Vector2.subtract(i,e.position));r.normalize(),r.multiply(this.opts.bondLength),t.position.add(e.position),t.position.add(r),t.previousPosition=e.position,t.positioned=!0}else if(t.value.isBridge){var s=(this.getTargets(t.id,e.id,t.value.bridgedRing),new Vector2(this.opts.bondLength,0));s.rotate(i),s.add(e.position),t.position=s,t.previousPosition=e.position,t.positioned=!0}else if(1==e.value.rings.length){var r=Vector2.subtract(i,e.position);r.invert(),r.normalize(),r.multiply(this.opts.bondLength),t.position.add(e.position),t.position.add(r),t.previousPosition=e.position,t.positioned=!0}else if(2==e.value.rings.length){var o=this.getRing(e.value.rings[0]),h=this.getRing(e.value.rings[1]),a=Vector2.subtract(h.center,o.center),l=Vector2.subtract(e.position,o.center),u=Vector2.scalarProjection(l,a);a.normalize(),a.multiply(u),a.add(o.center);var r=Vector2.subtract(a,e.position);r.invert(),r.normalize(),r.multiply(this.opts.bondLength),t.position.add(e.position),t.position.add(r),t.previousPosition=e.position,t.positioned=!0}}else{var s=new Vector2(this.opts.bondLength,0);s.rotate(i),s.add(e.position),t.position=s,t.previousPosition=e.position,t.positioned=!0}else{var c=new Vector2(this.opts.bondLength,0);c.rotate(MathHelper.toRad(-120)),t.previousPosition=c,t.position=new Vector2(this.opts.bondLength,0),t.angle=MathHelper.toRad(-120),t.positioned=!0}if(t.value.rings.length>0){var g=this.getRing(t.value.rings[0]),v=Vector2.subtract(t.previousPosition,t.position);v.invert(),v.normalize();var d=MathHelper.polyCircumradius(this.opts.bondLength,g.getSize());v.multiply(d),v.add(t.position),this.createRing(g,v,t)}else{var f=t.getNeighbours();e&&(f=ArrayHelper.remove(f,e.id));var p=t.getAngle();if(1==f.length){var y=this.vertices[f[0]];if("#"===t.value.bondType||e&&"#"===e.value.bondType)y.angle=p,this.createBonds(y,t,y.angle,-n);else{var m=Math.random()<.5?-1:1;n||(n=m),y.angle=MathHelper.toRad(60)*n,this.createBonds(y,t,p+y.angle,-n)}}else if(2==f.length){var b=this.getTreeDepth(t.id,f[0]),x=this.getTreeDepth(t.id,f[1]),A=0,k=1;if(b>x&&(A=1,k=0),1===t.position.clockwise(t.previousPosition)){var C=this.vertices[f[A]],R=this.vertices[f[k]];R.angle=MathHelper.toRad(60),C.angle=-MathHelper.toRad(60),this.createBonds(R,t,p+R.angle),this.createBonds(C,t,p+C.angle)}else{var C=this.vertices[f[A]],R=this.vertices[f[k]];R.angle=-MathHelper.toRad(60),C.angle=MathHelper.toRad(60),this.createBonds(C,t,p+C.angle),this.createBonds(R,t,p+R.angle)}}else if(3==f.length){var w=this.getTreeDepth(t.id,f[0]),V=this.getTreeDepth(t.id,f[1]),N=this.getTreeDepth(t.id,f[2]),u=this.vertices[f[0]],S=this.vertices[f[1]],d=this.vertices[f[2]];V>w&&V>N?(u=this.vertices[f[1]],S=this.vertices[f[0]],d=this.vertices[f[2]]):N>w&&N>V&&(u=this.vertices[f[2]],S=this.vertices[f[0]],d=this.vertices[f[1]]),this.createBonds(u,t,p),this.createBonds(S,t,p+MathHelper.toRad(90)),this.createBonds(d,t,p-MathHelper.toRad(90))}else if(4==f.length){var w=this.getTreeDepth(t.id,f[0]),V=this.getTreeDepth(t.id,f[1]),N=this.getTreeDepth(t.id,f[2]),B=this.getTreeDepth(t.id,f[3]),I=this.vertices[f[0]],T=this.vertices[f[1]],H=this.vertices[f[2]],M=this.vertices[f[3]];V>w&&V>N&&V>B?(I=this.vertices[f[1]],T=this.vertices[f[0]],H=this.vertices[f[2]],M=this.vertices[f[3]]):N>w&&N>V&&N>B?(I=this.vertices[f[2]],T=this.vertices[f[0]],H=this.vertices[f[1]],M=this.vertices[f[3]]):B>w&&B>V&&B>N&&(I=this.vertices[f[3]],T=this.vertices[f[0]],H=this.vertices[f[1]],M=this.vertices[f[2]]),this.createBonds(I,t,p-MathHelper.toRad(36)),this.createBonds(T,t,p+MathHelper.toRad(36)),this.createBonds(H,t,p-MathHelper.toRad(108)),this.createBonds(M,t,p+MathHelper.toRad(108))}}}}},{key:"getTargets",value:function(t,e,i){var n=this,r=new Array,s=function t(e,s){for(var o=n.vertices[e].getNeighbours(),h=0;h<o.length;h++){var a=n.vertices[o[h]];a.id!==s&&(a.value.isBridge?t(a.id,e):a.value.hasRing(i)&&r.push(a.id))}};return s(t,e),r}},{key:"getCommonRingbondNeighbour",value:function(t){for(var e=t.getNeighbours(),i=0;i<e.length;i++){var n=this.vertices[e[i]];if(ArrayHelper.containsAll(n.value.rings,t.value.rings))return n}}},{key:"isPointInRing",value:function(t){for(var e=0;e<this.rings.length;e++){var i=this.rings[e].getPolygon(this.vertices);if(t.isInPolygon(i))return!0}return!1}},{key:"isEdgeInRing",value:function(t){var e=this.vertices[t.sourceId],i=this.vertices[t.targetId];return this.areVerticesInSameRing(e,i)}},{key:"isRingAromatic",value:function(t){for(var e=0;e<t.members.length;e++)if(!this.isVertexInAromaticRing(t.members[e]))return!1;return!0}},{key:"isEdgeInAromaticRing",value:function(t){return this.isVertexInAromaticRing(t.sourceId)&&this.isVertexInAromaticRing(t.targetId)}},{key:"isVertexInAromaticRing",value:function(t){var e=this.vertices[t].value.element;return e==e.toLowerCase()}},{key:"getEdgeNormals",value:function(t){var e=this.vertices[t.sourceId].position,i=this.vertices[t.targetId].position,n=Vector2.normals(e,i);return ArrayHelper.each(n,function(t){t.normalize()}),n}},{key:"getNormals",value:function(t,e){var t=t.position,e=e.position,i=Vector2.normals(t,e);return ArrayHelper.each(i,function(t){t.normalize()}),i}},{key:"getTreeDepth",value:function(t,e){for(var i=this.vertices[e].getSpanningTreeNeighbours(t),n=0,r=0;r<i.length;r++){var s=i[r],o=this.getTreeDepth(e,s);o>n&&(n=o)}return n+1}},{key:"traverseTree",value:function(t,e,i){var n=this.vertices[e],r=n.getSpanningTreeNeighbours(t);i(n);for(var s=0;s<r.length;s++)this.traverseTree(e,r[s],i)}},{key:"getMaxDepth",value:function(t,e,i){i=i?i:0;for(var n=t.getNeighbours(),r=0,s=0;s<n.length;s++)if(n[s]!=e.id){var o=this.vertices[n[s]],h=0;h=o.value.getRingbondCount()>0?100:this.getMaxDepth(this.vertices[n[s]],t,i+1),h>r&&(r=h)}return r}},{key:"getBondCount",value:function(t){for(var e=0,i=0;i<t.edges.length;i++)e+=this.edges[t.edges[i]].getBondCount();return e}},{key:"getNonRingNeighbours",value:function(t){for(var e=[],i=this.vertices[t],n=i.getNeighbours(),r=0;r<n.length;r++){var s=this.vertices[n[r]],o=ArrayHelper.intersection(i.value.rings,s.value.rings).length;0===o&&0==s.value.isBridge&&e.push(s)}return e}}]),t}(),Edge=function(){function t(e,i,n){_classCallCheck(this,t),this.id=null,this.sourceId=e,this.targetId=i,this.weight=n,this.bondType="-",this.isInAromaticRing=!1}return _createClass(t,[{key:"getBondCount",value:function(){return t.bonds[this.bondType]}}],[{key:"bonds",get:function(){return{"-":1,"/":1,"\\":1,"=":2,"#":3,$:4}}}]),t}(),Line=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new Vector2(0,0),i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new Vector(0,0),n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;_classCallCheck(this,t),this.from=e,this.to=i,this.elementFrom=n,this.elementTo=r}return _createClass(t,[{key:"clone",value:function(){return new t(this.from.clone(),this.to.clone(),this.elementFrom,this.elementTo)}},{key:"getLength",value:function(){return Math.sqrt(Math.pow(this.to.x-this.from.x,2)+Math.pow(this.to.y-this.from.y,2))}},{key:"getAngle",value:function(){var t=Vector2.subtract(this.getRightVector(),this.getLeftVector());return t.angle()}},{key:"getRightVector",value:function(){return this.from.x<this.to.x?this.to:this.from}},{key:"getLeftVector",value:function(){return this.from.x<this.to.x?this.from:this.to}},{key:"getRightElement",value:function(){return this.from.x<this.to.x?this.elementTo:this.elementFrom}},{key:"getLeftElement",value:function(){return this.from.x<this.to.x?this.elementFrom:this.elementTo}},{key:"setRightVector",value:function(t,e){return this.from.x<this.to.x?this.to.set(t,e):this.from.set(t,e),this}},{key:"setLeftVector",value:function(t,e){return this.from.x<this.to.x?this.from.set(t,e):this.to.set(t,e),this}},{key:"rotateToXAxis",value:function(){var t=this.getLeftVector();return this.setRightVector(t.x+this.getLength(),t.y),this}},{key:"rotate",value:function(t){var e=this.getLeftVector(),i=this.getRightVector(),n=Math.cos(t)*(i.x-e.x)-Math.sin(t)*(i.y-e.y)+e.x,r=Math.sin(t)*(i.x-e.x)-Math.cos(t)*(i.y-e.y)+e.y;return this.setRightVector(n,r),this}},{key:"shortenFrom",value:function(t){var e=Vector2.subtract(this.to,this.from);return e.normalize(),e.multiply(t),this.from.add(e),this}},{key:"shortenTo",value:function(t){var e=Vector2.subtract(this.from,this.to);return e.normalize(),e.multiply(t),this.to.add(e),this}},{key:"shorten",value:function(t){var e=Vector2.subtract(this.from,this.to);return e.normalize(),e.multiply(t/2),this.to.add(e),this.from.subtract(e),this}}]),t}(),MathHelper=function(){function t(){_classCallCheck(this,t)}return _createClass(t,null,[{key:"round",value:function(t,e){return e=e?e:1,Number(Math.round(t+"e"+e)+"e-"+e)}},{key:"meanAngle",value:function(t){for(var e=0,i=0,n=0;n<t.length;n++)e+=Math.sin(t[n]),i+=Math.cos(t[n]);return Math.atan2(e/t.length,i/t.length)}},{key:"innerAngle",value:function(e){return t.toRad(180*(e-2)/e)}},{key:"polyCircumradius",value:function(t,e){return t/(2*Math.sin(Math.PI/e))}},{key:"apothem",value:function(t,e){return t*Math.cos(Math.PI/e)}},{key:"centralAngle",value:function(e){return t.toRad(360/e)}},{key:"toDeg",value:function(t){return 180*t/Math.PI}},{key:"toRad",value:function(t){return t*Math.PI/180}}]),t}(),Pair=function(){function t(e,i){_classCallCheck(this,t),this.first=e,this.second=i}return _createClass(t,[{key:"getHash",value:function(){return.5*(this.first+this.second)*(this.first+this.second+1)+(this.first+this.second)}},{key:"contains",value:function(t){return this.first===t||this.second===t}}],[{key:"createUniquePairs",value:function(e){for(var i=[],n=0;n<e.length;n++)for(var r=e[n],s=n+1;s<e.length;s++){var o=e[s];i.push(new t(r,o))}return i}}]),t}(),Ring=function(){function t(e,i,n){_classCallCheck(this,t),this.id=null,this.ringbond=e,this.sourceId=i,this.targetId=n,this.members=new Array,this.insiders=new Array,this.neighbours=new Array,this.positioned=!1,this.center=new Vector2,this.rings=new Array,this.isBridged=!1,this.template=null,this.isSpiro=!1,this.isFused=!1,this.radius=0,this.centralAngle=0,this.canFlip=!0}return _createClass(t,[{key:"clone",value:function e(){var e=new t(this.ringbond,this.sourceId,this.target);return e.id=this.id,e.members=ArrayHelper.clone(this.members),e.insiders=ArrayHelper.clone(this.insiders),e.neighbours=ArrayHelper.clone(this.neighbours),e.positioned=this.positioned,e.center=this.center.clone(),e.rings=ArrayHelper.clone(this.rings),e.isBridged=this.isBridged,e.template=this.template,e.isSpiro=this.isSpiro,e.isFused=this.isFused,e.radius=this.radius,e.centralAngle=this.centralAngle,e.canFlip=this.canFlip,e}},{key:"allowsFlip",value:function(){return this.canFlip&&this.members.length>4}},{key:"setFlipped",value:function(){this.members.length<8&&(this.canFlip=!1)}},{key:"getSize",value:function(){return this.members.length}},{key:"getPolygon",value:function(t){for(var e=[],i=0;i<this.members.length;i++)e.push(t[this.members[i]].position);return e}},{key:"getAngle",value:function(){return Math.PI-this.centralAngle}},{key:"eachMember",value:function(t,e,i,n){i=i||0===i?i:this.members[0];for(var r=i,s=0;null!=r&&s<100;){var o=r;e(o),r=t[r].getNextInRing(t,this.id,n),n=o,r==i&&(r=null),99==s&&console.log("Smiles-drawer was not able to loop over the members of this ring.",this),s++}}},{key:"getOrderedNeighbours",value:function(t){for(var e=[],i=0;i<this.neighbours.length;i++){var n=RingConnection.getVertices(t,this.id,this.neighbours[i]);e.push({n:n.length,neighbour:this.neighbours[i]})}return e.sort(function(t,e){return e.n-t.n}),e}},{key:"isAromatic",value:function(t){for(var e=0;e<this.members.length;e++){var i=t[this.members[e]].value.element.charAt(0);if(i==i.toUpperCase())return!1}return!0}},{key:"contains",value:function(t){for(var e=0;e<this.members.length;e++)if(this.members[e]==t)return!0;return!1}},{key:"thisOrNeighboursContain",value:function(e,i){for(var n=0;n<this.neighbours.length;n++)if(t.getRing(e,this.neighbours[n]).contains(i))return!0;return!!this.contains(i)}},{key:"hasSource",value:function(){return!(void 0===this.sourceId||null===this.sourceId)}},{key:"hasTarget",value:function(){return!(void 0===this.targetId||null===this.targetId)}},{key:"hasSourceAndTarget",value:function(){return this.hasSource()&&this.hasTarget()}}],[{key:"getRing",value:function(t,e){for(var i=0;i<t.length;i++)if(t[i].id==e)return t[i]}}]),t}(),RingConnection=function(){function t(e,i){_classCallCheck(this,t),this.id=null,this.rings=new Pair(e.id,i.id),this.vertices=[];for(var n=0;n<e.members.length;n++)for(var r=e.members[n],s=0;s<i.members.length;s++){var o=i.members[s];r===o&&this.addVertex(r)}}return _createClass(t,[{key:"addVertex",value:function(t){ArrayHelper.contains(this.vertices,{value:t})||this.vertices.push(t)}},{key:"isBridge",value:function(t){if(this.vertices.length>2)return!0;for(var e=0;e<this.vertices.length;e++){var i=this.vertices[e];if(t[i].value.rings.length>2)return!0}return!1}},{key:"updateOther",value:function(t,e){this.rings.first===e?this.rings.second=t:this.rings.first=t}}],[{key:"isBridge",value:function(t,e,i,n){for(var r=null,s=0;s<t.length;s++){r=t[s];var o=r.rings;if(o.first===i&&o.second===n||o.first===n&&o.second===i)return r.isBridge(e)}return!1}},{key:"getNeighbours",value:function(t,e){for(var i=[],n=0;n<t.length;n++){var r=t[n].rings;r.first===e?i.push(r.second):r.second===e&&i.push(r.first)}return i}},{key:"getVertices",value:function(t,e,i){for(var n=0;n<t.length;n++){var r=t[n];if(r.rings.first==e&&r.rings.second==i||r.rings.first==i&&r.rings.second==e)return r.vertices}}}]),t}(),smiles=function(){function t(t,e){function i(){this.constructor=t}i.prototype=e.prototype,t.prototype=new i}function e(t,i,n,r){this.message=t,this.expected=i,this.found=n,this.location=r,this.name="SyntaxError","function"==typeof Error.captureStackTrace&&Error.captureStackTrace(this,e)}function i(t){function i(e){var i,n,r=ie[e];if(r)return r;for(i=e-1;!ie[i];)i--;for(r=ie[i],r={line:r.line,column:r.column,seenCR:r.seenCR};i<e;)n=t.charAt(i),"\n"===n?(r.seenCR||r.line++,r.column=1,r.seenCR=!1):"\r"===n||"\u2028"===n||"\u2029"===n?(r.line++,r.column=1,r.seenCR=!0):(r.column++,r.seenCR=!1),i++;return ie[e]=r,r}function n(t,e){var n=i(t),r=i(e);return{start:{offset:t,line:n.line,column:n.column},end:{offset:e,line:r.line,column:r.column}}}function r(t){te<ne||(te>ne&&(ne=te,re=[]),re.push(t))}function s(t,i,n,r){function s(t){var e=1;for(t.sort(function(t,e){return t.description<e.description?-1:t.description>e.description?1:0});e<t.length;)t[e-1]===t[e]?t.splice(e,1):e++}function o(t,e){function i(t){function e(t){return t.charCodeAt(0).toString(16).toUpperCase()}return t.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\x08/g,"\\b").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\f/g,"\\f").replace(/\r/g,"\\r").replace(/[\x00-\x07\x0B\x0E\x0F]/g,function(t){return"\\x0"+e(t)}).replace(/[\x10-\x1F\x80-\xFF]/g,function(t){return"\\x"+e(t)}).replace(/[\u0100-\u0FFF]/g,function(t){return"\\u0"+e(t)}).replace(/[\u1000-\uFFFF]/g,function(t){return"\\u"+e(t)})}var n,r,s,o=new Array(t.length);for(s=0;s<t.length;s++)o[s]=t[s].description;return n=t.length>1?o.slice(0,-1).join(", ")+" or "+o[t.length-1]:o[0],r=e?'"'+i(e)+'"':"end of input","Expected "+n+" but "+r+" found."}return null!==i&&s(i),new e(null!==t?t:o(i,n),i,n,r)}function o(){var t,e,i,n,r,s,u,c,g,v;if(t=te,e=te,i=a(),i!==w){for(n=[],r=h();r!==w;)n.push(r),r=h();if(n!==w){for(r=[],s=te,u=l(),u===w&&(u=null),u!==w?(c=f(),c!==w?(u=[u,c],s=u):(te=s,s=w)):(te=s,s=w);s!==w;)r.push(s),s=te,u=l(),u===w&&(u=null),u!==w?(c=f(),c!==w?(u=[u,c],s=u):(te=s,s=w)):(te=s,s=w);if(r!==w){for(s=[],u=h();u!==w;)s.push(u),u=h();if(s!==w)if(u=l(),u===w&&(u=null),u!==w)if(c=o(),c===w&&(c=null),c!==w){for(g=[],v=h();v!==w;)g.push(v),v=h();g!==w?(i=[i,n,r,s,u,c,g],e=i):(te=e,e=w)}else te=e,e=w;else te=e,e=w;else te=e,e=w}else te=e,e=w}else te=e,e=w}else te=e,e=w;return e!==w&&(ee=t,e=S(e)),t=e}function h(){var e,i,n,s,h,a;return e=te,i=te,40===t.charCodeAt(te)?(n=B,te++):(n=w,0===se&&r(I)),n!==w?(s=l(),s===w&&(s=null),s!==w?(h=o(),h!==w?(41===t.charCodeAt(te)?(a=T,te++):(a=w,0===se&&r(H)),a!==w?(n=[n,s,h,a],i=n):(te=i,i=w)):(te=i,i=w)):(te=i,i=w)):(te=i,i=w),i!==w&&(ee=e,i=M(i)),e=i}function a(){var t,e;return t=te,e=c(),e===w&&(e=g(),e===w&&(e=u(),e===w&&(e=v()))),e!==w&&(ee=t,e=L(e)),t=e}function l(){var e,i;return e=te,P.test(t.charAt(te))?(i=t.charAt(te),te++):(i=w,0===se&&r(O)),i!==w&&(ee=e,i=F(i)),e=i}function u(){var e,i,n,s,o,h,a,l,u,c;return e=te,i=te,91===t.charCodeAt(te)?(n=E,te++):(n=w,0===se&&r(_)),n!==w?(s=k(),s===w&&(s=null),s!==w?(t.substr(te,2)===z?(o=z,te+=2):(o=w,0===se&&r(D)),o===w&&(t.substr(te,2)===W?(o=W,te+=2):(o=w,0===se&&r(X)),o===w&&(o=g(),o===w&&(o=d(),o===w&&(o=v())))),o!==w?(h=p(),h===w&&(h=null),h!==w?(a=x(),a===w&&(a=null),a!==w?(l=y(),l===w&&(l=null),l!==w?(u=A(),u===w&&(u=null),u!==w?(93===t.charCodeAt(te)?(c=j,te++):(c=w,0===se&&r(U)),c!==w?(n=[n,s,o,h,a,l,u,c],i=n):(te=i,i=w)):(te=i,i=w)):(te=i,i=w)):(te=i,i=w)):(te=i,i=w)):(te=i,i=w)):(te=i,i=w)):(te=i,i=w),i!==w&&(ee=e,i=q(i)),e=i}function c(){var e,i,n,s;return e=te,i=te,66===t.charCodeAt(te)?(n=Y,te++):(n=w,0===se&&r(G)),n!==w?(114===t.charCodeAt(te)?(s=K,te++):(s=w,0===se&&r($)),s===w&&(s=null),s!==w?(n=[n,s],i=n):(te=i,i=w)):(te=i,i=w),i===w&&(i=te,67===t.charCodeAt(te)?(n=Z,te++):(n=w,0===se&&r(J)),n!==w?(108===t.charCodeAt(te)?(s=Q,te++):(s=w,0===se&&r(tt)),s===w&&(s=null),s!==w?(n=[n,s],i=n):(te=i,i=w)):(te=i,i=w),i===w&&(et.test(t.charAt(te))?(i=t.charAt(te),te++):(i=w,0===se&&r(it)))),i!==w&&(ee=e,i=nt(i)),e=i}function g(){var e,i;return e=te,rt.test(t.charAt(te))?(i=t.charAt(te),te++):(i=w,0===se&&r(st)),i!==w&&(ee=e,i=L(i)),e=i}function v(){var e,i;return e=te,42===t.charCodeAt(te)?(i=ot,te++):(i=w,0===se&&r(ht)),i!==w&&(ee=e,i=at(i)),e=i}function d(){var e,i,n,s;return e=te,i=te,lt.test(t.charAt(te))?(n=t.charAt(te),te++):(n=w,0===se&&r(ut)),n!==w?(ct.test(t.charAt(te))?(s=t.charAt(te),te++):(s=w,0===se&&r(gt)),s===w&&(s=null),s!==w?(n=[n,s],i=n):(te=i,i=w)):(te=i,i=w),i!==w&&(ee=e,i=vt(i)),e=i}function f(){var e,i,n,s,o;return e=te,i=te,37===t.charCodeAt(te)?(n=dt,te++):(n=w,0===se&&r(ft)),n!==w?(pt.test(t.charAt(te))?(s=t.charAt(te),te++):(s=w,0===se&&r(yt)),s!==w?(mt.test(t.charAt(te))?(o=t.charAt(te),te++):(o=w,0===se&&r(bt)),o!==w?(n=[n,s,o],i=n):(te=i,i=w)):(te=i,i=w)):(te=i,i=w),i===w&&(mt.test(t.charAt(te))?(i=t.charAt(te),te++):(i=w,0===se&&r(bt))),i!==w&&(ee=e,i=xt(i)),e=i}function p(){var e,i,n,s,o,h,a;return e=te,i=te,64===t.charCodeAt(te)?(n=At,te++):(n=w,0===se&&r(kt)),n!==w?(64===t.charCodeAt(te)?(s=At,te++):(s=w,0===se&&r(kt)),s===w&&(s=te,t.substr(te,2)===Ct?(o=Ct,te+=2):(o=w,0===se&&r(Rt)),o!==w?(wt.test(t.charAt(te))?(h=t.charAt(te),te++):(h=w,0===se&&r(Vt)),h!==w?(o=[o,h],s=o):(te=s,s=w)):(te=s,s=w),s===w&&(s=te,t.substr(te,2)===Nt?(o=Nt,te+=2):(o=w,0===se&&r(St)),o!==w?(wt.test(t.charAt(te))?(h=t.charAt(te),te++):(h=w,0===se&&r(Vt)),h!==w?(o=[o,h],s=o):(te=s,s=w)):(te=s,s=w),s===w&&(s=te,t.substr(te,2)===Bt?(o=Bt,te+=2):(o=w,0===se&&r(It)),o!==w?(Tt.test(t.charAt(te))?(h=t.charAt(te),te++):(h=w,0===se&&r(Ht)),h!==w?(o=[o,h],s=o):(te=s,s=w)):(te=s,s=w),s===w&&(s=te,t.substr(te,2)===Mt?(o=Mt,te+=2):(o=w,0===se&&r(Lt)),o!==w?(pt.test(t.charAt(te))?(h=t.charAt(te),te++):(h=w,0===se&&r(yt)),h!==w?(mt.test(t.charAt(te))?(a=t.charAt(te),te++):(a=w,0===se&&r(bt)),a===w&&(a=null),a!==w?(o=[o,h,a],s=o):(te=s,s=w)):(te=s,s=w)):(te=s,s=w),s===w&&(s=te,t.substr(te,2)===Pt?(o=Pt,te+=2):(o=w,0===se&&r(Ot)),o!==w?(pt.test(t.charAt(te))?(h=t.charAt(te),te++):(h=w,0===se&&r(yt)),h!==w?(mt.test(t.charAt(te))?(a=t.charAt(te),te++):(a=w,0===se&&r(bt)),a===w&&(a=null),a!==w?(o=[o,h,a],s=o):(te=s,s=w)):(te=s,s=w)):(te=s,s=w)))))),s===w&&(s=null),s!==w?(n=[n,s],i=n):(te=i,i=w)):(te=i,i=w),i!==w&&(ee=e,i=Ft(i)),e=i}function y(){var t,e;return t=te,e=m(),e===w&&(e=b()),e!==w&&(ee=t,e=Et(e)),t=e}function m(){var e,i,n,s,o,h;return e=te,i=te,43===t.charCodeAt(te)?(n=_t,te++):(n=w,0===se&&r(zt)),n!==w?(43===t.charCodeAt(te)?(s=_t,te++):(s=w,0===se&&r(zt)),s===w&&(s=te,pt.test(t.charAt(te))?(o=t.charAt(te),te++):(o=w,0===se&&r(yt)),o!==w?(mt.test(t.charAt(te))?(h=t.charAt(te),te++):(h=w,0===se&&r(bt)),h===w&&(h=null),h!==w?(o=[o,h],s=o):(te=s,s=w)):(te=s,s=w)),s===w&&(s=null),s!==w?(n=[n,s],i=n):(te=i,i=w)):(te=i,i=w),i!==w&&(ee=e,i=Dt(i)),e=i}function b(){var e,i,n,s,o,h;return e=te,i=te,45===t.charCodeAt(te)?(n=Wt,te++):(n=w,0===se&&r(Xt)),n!==w?(45===t.charCodeAt(te)?(s=Wt,te++):(s=w,0===se&&r(Xt)),s===w&&(s=te,pt.test(t.charAt(te))?(o=t.charAt(te),te++):(o=w,0===se&&r(yt)),o!==w?(mt.test(t.charAt(te))?(h=t.charAt(te),te++):(h=w,0===se&&r(bt)),h===w&&(h=null),h!==w?(o=[o,h],s=o):(te=s,s=w)):(te=s,s=w)),s===w&&(s=null),s!==w?(n=[n,s],i=n):(te=i,i=w)):(te=i,i=w),i!==w&&(ee=e,i=jt(i)),e=i}function x(){var e,i,n,s;return e=te,i=te,72===t.charCodeAt(te)?(n=Ut,te++):(n=w,0===se&&r(qt)),n!==w?(mt.test(t.charAt(te))?(s=t.charAt(te),te++):(s=w,0===se&&r(bt)),s===w&&(s=null),s!==w?(n=[n,s],i=n):(te=i,i=w)):(te=i,i=w),i!==w&&(ee=e,i=Yt(i)),e=i}function A(){var e,i,n,s,o,h,a;if(e=te,i=te,58===t.charCodeAt(te)?(n=Gt,te++):(n=w,0===se&&r(Kt)),n!==w){if(s=te,pt.test(t.charAt(te))?(o=t.charAt(te),te++):(o=w,0===se&&r(yt)),o!==w){for(h=[],mt.test(t.charAt(te))?(a=t.charAt(te),te++):(a=w,0===se&&r(bt));a!==w;)h.push(a),mt.test(t.charAt(te))?(a=t.charAt(te),te++):(a=w,0===se&&r(bt));h!==w?(o=[o,h],s=o):(te=s,s=w)}else te=s,s=w;s===w&&($t.test(t.charAt(te))?(s=t.charAt(te),te++):(s=w,0===se&&r(Zt))),s!==w?(n=[n,s],i=n):(te=i,i=w)}else te=i,i=w;return i!==w&&(ee=e,i=Jt(i)),e=i}function k(){var e,i,n,s,o;return e=te,i=te,pt.test(t.charAt(te))?(n=t.charAt(te),te++):(n=w,0===se&&r(yt)),n!==w?(mt.test(t.charAt(te))?(s=t.charAt(te),te++):(s=w,0===se&&r(bt)),s===w&&(s=null),s!==w?(mt.test(t.charAt(te))?(o=t.charAt(te),te++):(o=w,0===se&&r(bt)),o===w&&(o=null),o!==w?(n=[n,s,o],i=n):(te=i,i=w)):(te=i,i=w)):(te=i,i=w),i!==w&&(ee=e,i=Qt(i)),e=i}var C,R=arguments.length>1?arguments[1]:{},w={},V={chain:o},N=o,S=function(t){for(var e=[],i=[],n=0;n<t[1].length;n++)e.push(t[1][n]);for(var n=0;n<t[2].length;n++){var r=t[2][n][0]?t[2][n][0]:"-";i.push({bond:r,id:t[2][n][1]})}for(var n=0;n<t[3].length;n++)e.push(t[3][n]);for(var n=0;n<t[6].length;n++)e.push(t[6][n]);return{atom:t[0],isBracket:!!t[0].element,branches:e,branchCount:e.length,ringbonds:i,ringbondCount:i.length,bond:t[4]?t[4]:"-",next:t[5],hasNext:!!t[5]}},B="(",I={type:"literal",value:"(",description:'"("'},T=")",H={type:"literal",value:")",description:'")"'},M=function(t){var e=t[1]?t[1]:"-";return t[2].branchBond=e,t[2]},L=function(t){return t},P=/^[\-=#$:\/\\.]/,O={type:"class",value:"[-=#$:/\\\\.]",description:"[-=#$:/\\\\.]"},F=function(t){return t},E="[",_={type:"literal",value:"[",description:'"["'},z="se",D={type:"literal",value:"se",description:'"se"'},W="as",X={type:"literal",value:"as",description:'"as"'},j="]",U={type:"literal",value:"]",description:'"]"'},q=function(t){return{isotope:t[1],element:t[2],chirality:t[3],hcount:t[4],charge:t[5],class:t[6]}},Y="B",G={type:"literal",value:"B",description:'"B"'},K="r",$={type:"literal",value:"r",description:'"r"'},Z="C",J={type:"literal",value:"C",description:'"C"'},Q="l",tt={type:"literal",value:"l",description:'"l"'},et=/^[NOPSFI]/,it={type:"class",value:"[NOPSFI]",description:"[NOPSFI]"},nt=function(t){return t.length>1?t.join(""):t},rt=/^[bcnops]/,st={type:"class",value:"[bcnops]",description:"[bcnops]"},ot="*",ht={type:"literal",value:"*",description:'"*"'},at=function(t){return t},lt=/^[A-Z]/,ut={type:"class",value:"[A-Z]",description:"[A-Z]"},ct=/^[a-z]/,gt={type:"class",value:"[a-z]",description:"[a-z]"},vt=function(t){return t.join("")},dt="%",ft={type:"literal",value:"%",description:'"%"'},pt=/^[1-9]/,yt={type:"class",value:"[1-9]",description:"[1-9]"},mt=/^[0-9]/,bt={type:"class",value:"[0-9]",description:"[0-9]"},xt=function(t){return 1==t.length?Number(t):Number(t.join("").replace("%",""))},At="@",kt={type:"literal",value:"@",description:'"@"'},Ct="TH",Rt={type:"literal",value:"TH",description:'"TH"'},wt=/^[12]/,Vt={type:"class",value:"[12]",description:"[12]"},Nt="AL",St={type:"literal",value:"AL",description:'"AL"'},Bt="SP",It={type:"literal",value:"SP",description:'"SP"'},Tt=/^[1-3]/,Ht={type:"class",value:"[1-3]",description:"[1-3]"},Mt="TB",Lt={type:"literal",value:"TB",description:'"TB"'},Pt="OH",Ot={type:"literal",value:"OH",description:'"OH"'},Ft=function(t){return t[1]?"@"==t[1]?"@@":t[1].join("").replace(",",""):"@"},Et=function(t){return t},_t="+",zt={type:"literal",value:"+",description:'"+"'},Dt=function(t){return t[1]?"+"!=t[1]?Number(t[1].join("")):2:1},Wt="-",Xt={type:"literal",value:"-",description:'"-"'},jt=function(t){return t[1]?"-"!=t[1]?-Number(t[1].join("")):-2:-1},Ut="H",qt={type:"literal",value:"H",description:'"H"'},Yt=function(t){return t[1]?Number(t[1]):1},Gt=":",Kt={type:"literal",value:":",description:'":"'},$t=/^[0]/,Zt={type:"class",value:"[0]",description:"[0]"},Jt=function(t){return Number(t[1][0]+t[1][1].join(""))},Qt=function(t){return Number(t.join(""))},te=0,ee=0,ie=[{line:1,column:1,seenCR:!1}],ne=0,re=[],se=0;if("startRule"in R){if(!(R.startRule in V))throw new Error("Can't start parsing from rule \""+R.startRule+'".');N=V[R.startRule]}if(C=N(),C!==w&&te===t.length)return C;throw C!==w&&te<t.length&&r({type:"end",description:"end of input"}),s(null,re,ne<t.length?t.charAt(ne):null,ne<t.length?n(ne,ne+1):n(ne,ne))}return t(e,Error),{SyntaxError:e,parse:i}}(),Vector2=function(){function t(e,i){_classCallCheck(this,t),0==arguments.length?(this.x=0,this.y=0):1==arguments.length?(this.x=e.x,this.y=e.y):(this.x=e,this.y=i)}return _createClass(t,[{key:"set",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;this.x=t,this.y=e}},{key:"clone",value:function(){return new t(this.x,this.y)}},{key:"toString",value:function(){return"("+this.x+","+this.y+")"}},{key:"add",value:function(t){this.x+=t.x,this.y+=t.y}},{key:"subtract",value:function(t){this.x-=t.x,this.y-=t.y}},{key:"divide",value:function(t){this.x/=t,this.y/=t}},{key:"multiply",value:function(t){this.x*=t,this.y*=t}},{key:"invert",value:function(){this.x=-this.x,this.y=-this.y}},{key:"angle",value:function(){return Math.atan2(this.y,this.x)}},{key:"distance",value:function(t){return Math.sqrt((t.x-this.x)*(t.x-this.x)+(t.y-this.y)*(t.y-this.y))}},{key:"distanceSq",value:function(t){return(t.x-this.x)*(t.x-this.x)+(t.y-this.y)*(t.y-this.y)}},{key:"clockwise",value:function(t){var e=this.y*t.x,i=this.x*t.y;return e>i?-1:e===i?0:1}},{key:"rotate",value:function(e){var i=new t;i.x=this.x*Math.cos(e)-this.y*Math.sin(e),i.y=this.x*Math.sin(e)+this.y*Math.cos(e),this.x=i.x,this.y=i.y}},{key:"rotateAround",value:function(t,e){var i=Math.sin(t),n=Math.cos(t);this.x-=e.x,this.y-=e.y;var r=this.x*n-this.y*i,s=this.x*i+this.y*n;this.x=r+e.x,this.y=s+e.y}},{key:"rotateTo",value:function(e,i){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=t.subtract(this,i),s=t.subtract(e,i),o=t.angle(s,r);this.rotateAround(o+n,i)}},{key:"getRotateToAngle",value:function(e,i){var n=t.subtract(this,i),r=t.subtract(e,i),s=t.angle(r,n);return s}},{key:"isInPolygon",value:function(t){for(var e=!1,i=0,n=t.length-1;i<t.length;n=i++)t[i].y>this.y!=t[n].y>this.y&&this.x<(t[n].x-t[i].x)*(this.y-t[i].y)/(t[n].y-t[i].y)+t[i].x&&(e=!e);return e}},{key:"length",value:function(){return Math.sqrt(this.x*this.x+this.y*this.y)}},{key:"normalize",value:function(){this.divide(this.length())}},{key:"normalized",value:function(){return t.divide(this,this.length())}},{key:"whichSide",value:function(t,e){return(this.x-t.x)*(e.y-t.y)-(this.y-t.y)*(e.x-t.x)}},{key:"sameSideAs",value:function(t,e,i){var n=this.whichSide(t,e),r=i.whichSide(t,e);return n<0&&r<0||0==n&&0==r||n>0&&r>0}}],[{key:"add",value:function(e,i){return new t(e.x+i.x,e.y+i.y)}},{key:"subtract",value:function(e,i){return new t(e.x-i.x,e.y-i.y)}},{key:"multiply",value:function(e,i){return i.x&&i.y?new t(e.x*i.x,e.y*i.y):new t(e.x*i,e.y*i)}},{key:"midpoint",value:function(e,i){return new t((e.x+i.x)/2,(e.y+i.y)/2)}},{key:"normals",value:function(e,i){var n=t.subtract(i,e);return[new t(-n.y,n.x),new t(n.y,-n.x)]}},{key:"divide",value:function(e,i){return i.x&&i.y?new t(e.x/i.x,e.y/i.y):new t(e.x/i,e.y/i)}},{key:"dot",value:function(t,e){return t.x*e.x+t.y*e.y}},{key:"angle",value:function(e,i){var n=t.dot(e,i);return Math.acos(n/(e.length()*i.length()))}},{key:"scalarProjection",value:function(e,i){var n=i.normalized();return t.dot(e,n)}}]),t}(),Vertex=function(){function t(e){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;_classCallCheck(this,t),this.id=null,this.value=e,this.position=new Vector2(i?i:0,n?n:0),this.previousPosition=new Vector2(0,0),this.parentVertexId=null,this.children=[],this.spanningTreeChildren=[],this.edges=[],this.positioned=!1,this.angle=0,this.backAngle=0,this.flippable=!1,this.flipCenter=null,this.flipNeighbour=null,this.flipRings=new Array}return _createClass(t,[{key:"isTerminal",value:function(){return null===this.parentVertexId&&this.children.length<2||0===this.children.length}},{key:"clone",value:function e(){var e=new t(this.value,this.position.x,this.position.y);return e.id=this.id,e.previousPosition=new Vector2(this.previousPosition.x,this.previousPosition.y),e.parentVertexId=this.parentVertexId,e.children=ArrayHelper.clone(this.children),e.spanningTreeChildren=ArrayHelper.clone(this.spanningTreeChildren),e.edges=ArrayHelper.clone(this.edges),e.positioned=this.positioned,e.angle=this.angle,e.backAngle=this.backAngle,e.flippable=this.flippable,e.flipCenter=this.flipCenter,e.flipRings=ArrayHelper.clone(this.flipRings),e}},{key:"equals",value:function(t){return this.id===t.id;
}},{key:"getAngle",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,e=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=null;return i=t?Vector2.subtract(this.position,t):Vector2.subtract(this.position,this.previousPosition),e?MathHelper.toDeg(i.angle()):i.angle()}},{key:"getTextDirection",value:function(t){for(var e=this.getNeighbours(),i=[],n=0;n<e.length;n++)i.push(this.getAngle(t[e[n]].position));var r=MathHelper.meanAngle(i),s=Math.PI/2;return r=Math.round(Math.round(r/s)*s,3),2==r?"down":r==-2?"up":0===r||r===-0?"right":3==r||r==-3?"left":"down"}},{key:"getNeighbours",value:function(){for(var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,e=[],i=0;i<this.children.length;i++)void 0!==t&&t==this.children[i]||e.push(this.children[i]);return null!=this.parentVertexId&&(void 0!==t&&t==this.parentVertexId||e.push(this.parentVertexId)),e}},{key:"getCommonNeighbours",value:function(t){for(var e=new Array,i=this.getNeighbours(),n=t.getNeighbours(),r=0;r<i.length;r++)for(var s=0;s<n.length;s++)i[r]===n[s]&&e.push(i[r]);return e}},{key:"isNeighbour",value:function(t){if(this.parentVertexId===t)return!0;for(var e=0;e<this.children.length;e++)if(this.children[e]===t)return!0}},{key:"getSpanningTreeNeighbours",value:function(){for(var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,e=[],i=0;i<this.spanningTreeChildren.length;i++)void 0!==t&&t==this.spanningTreeChildren[i]||e.push(this.spanningTreeChildren[i]);return null!=this.parentVertexId&&(void 0!==t&&t==this.parentVertexId||e.push(this.parentVertexId)),e}},{key:"getNextInRing",value:function(t,e,i){for(var n=this.getNeighbours(),r=0;r<n.length;r++)if(ArrayHelper.contains(t[n[r]].value.rings,{value:e})&&n[r]!=i)return n[r];return null}}]),t}();